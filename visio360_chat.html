<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Visio360 • Telemetria → JSONBin.io</title>

<!-- ======== ESTILO ENXUTO ======== -->
<style>
:root{--bg:#f2f3fa;--panel:#fff;--borda:#ddd;--shadow:rgba(0,0,0,.06)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);display:flex;flex-direction:column;align-items:center;padding:1.5rem}
h1{margin-bottom:1rem}
.panel{background:var(--panel);border:1px solid var(--borda);border-radius:12px;padding:1rem 1.5rem;max-width:480px;width:100%;box-shadow:0 4px 12px var(--shadow);margin-bottom:1.2rem}
.row{display:flex;justify-content:space-between;margin:.45rem 0}
.output{font-size:1.45rem;font-weight:700}
button{padding:.55rem 1rem;border:0;border-radius:8px;font-weight:600;cursor:pointer;color:#fff}
#pumpBtn{background:#e53e3e}
#pumpBtn.on{background:#2f855a}
#pauseBtn{background:#6b46c1}
.status{padding:.25rem .6rem;border-radius:6px;font-size:.85rem}
.ok{background:#c6f6d5;color:#22543d}
.err{background:#fed7d7;color:#742a2a}
.syn{background:#faf089;color:#744210}
small{font-size:.75rem;color:#555}
</style>
</head>
<body>

<h1>Visio360 • Demo JSONBin</h1>

<!-- ======== PAINEL DE DADOS ======== -->
<div class="panel">
  <div class="row"><span>Temperatura:</span><span id="temp"  class="output">--</span></div>
  <div class="row"><span>Pressão&nbsp;&nbsp;&nbsp;:</span><span id="pres"  class="output">--</span></div>
  <div class="row"><span>Vazão&nbsp;&nbsp;&nbsp;&nbsp;:</span><span id="flow"  class="output">--</span></div>
  <div class="row"><span>Último envio:</span><span id="last"  class="output" style="font-size:1rem">--</span></div>
  <div class="row" style="margin-top:.9rem;gap:.5rem">
      <button id="pumpBtn">⚡ Ligar bomba</button>
      <button id="pauseBtn">⏸️ Pausar</button>
  </div>
</div>

<!-- ======== STATUS JSONBIN ======== -->
<div class="panel">
  <div class="row">
    <span>Status de sincronização:</span>
    <span id="sync" class="status err">desconectado</span>
  </div>
  <small>Bin ID salvo: <span id="binId">—</span></small>
</div>

<!-- ======== SCRIPT PRINCIPAL ======== -->
<script>
/* === CONFIGURAÇÃO JSONBIN === */
const BIN_KEY = 'visio360_binId';                                                  // key localStorage
const MASTER  = '$2a$10$ehifIomeYlvgvVrxyYhNw.vd4bqTcXj08tw.WEimXjpmizl7wd/tS';   // X-Master-Key
const ACCESS  = '$2a$10$8v56/OHJeikD7qlZWVLOnuZE6wGaC9mv3sAuWg2z9z2HEXa6q9d32';   // X-Access-Key (opcional)
const API     = 'https://api.jsonbin.io/v3';

let binId  = localStorage.getItem(BIN_KEY) || null;

/* === ELEMENTOS HTML === */
const $ = id => document.getElementById(id);
const elTemp  = $('temp');
const elPres  = $('pres');
const elFlow  = $('flow');
const elLast  = $('last');
const elSync  = $('sync');
const elBinId = $('binId');
const btnPump = $('pumpBtn');
const btnPause= $('pauseBtn');

/* === ESTADO === */
let pumpOn = false;
let paused = false;
let dataLog = [];

/* === FUNÇÕES AUXILIARES === */
const rnd = (mn,mx,dec=2)=>+(Math.random()*(mx-mn)+mn).toFixed(dec);

function gerarLeitura(){
  return pumpOn
    ? {timestamp:new Date().toISOString(),
       temperature:rnd(20,80),
       pressure:rnd(1,5),
       flow_rate:rnd(50,100,1),
       pump_status:'on'}
    : {timestamp:new Date().toISOString(),
       temperature:null,pressure:null,flow_rate:null,pump_status:'off'};
}

function atualizarDisplay(d){
  elTemp.textContent = d.temperature ?? '--';
  elPres.textContent = d.pressure    ?? '--';
  elFlow.textContent = d.flow_rate   ?? '--';
}

/* === ENVIO AO JSONBIN === */
async function saveJSONBin(payload){
  const url  = binId ? `${API}/b/${binId}` : `${API}/b`;
  const opts = {
    method : binId ? 'PUT' : 'POST',
    headers: {
      'Content-Type':'application/json',
      'X-Master-Key': MASTER
    },
    body: JSON.stringify(payload)
  };
  if (ACCESS) opts.headers['X-Access-Key'] = ACCESS;

  const res = await fetch(url, opts);
  if(!res.ok) throw new Error(res.status);
  const out = await res.json();

  /* guarda id novo */
  if(!binId){
    binId = out.metadata.id;
    localStorage.setItem(BIN_KEY, binId);
    elBinId.textContent = binId;
  }
}

/* === LOOP DE MEDIÇÃO (2 s) === */
setInterval(()=>{
  if(paused) return;
  const leitura = gerarLeitura();
  atualizarDisplay(leitura);
  if(pumpOn) dataLog.push(leitura);
}, 2000);

/* === LOOP DE SINCRONIZAÇÃO (10 s) === */
setInterval(async ()=>{
  if(paused||!pumpOn||!dataLog.length) return;
  elSync.className='status syn'; elSync.textContent='enviando…';
  try{
    await saveJSONBin(dataLog.slice(-10));      // envia os últimos 10 registros
    elSync.className='status ok';  elSync.textContent='ok';
    elLast.textContent = new Date().toLocaleTimeString('pt-BR');
  }catch(e){
    elSync.className='status err'; elSync.textContent='erro';
    console.error('JSONBin',e);
  }
}, 10000);

/* === HANDLERS DE BOTÕES === */
btnPump.onclick = ()=>{
  pumpOn = !pumpOn;
  btnPump.classList.toggle('on', pumpOn);
  btnPump.textContent = pumpOn ? '⚡ Desligar bomba' : '⚡ Ligar bomba';
};
btnPause.onclick = ()=>{
  paused = !paused;
  btnPause.textContent = paused ? '▶️ Continuar' : '⏸️ Pausar';
};

/* === MOSTRA BIN ID SE JÁ EXISTIA === */
if(binId) elBinId.textContent = binId;
</script>
</body>
</html>
